{% extends 'base.html' %}
{% load humanize %}

{% block title %}Dashboard de Administración{% endblock %}

{% block extra_css %}
<style>
    .admin-card {
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        height: 100%;
        border: none;
        border-radius: 15px;
    }
    
    .admin-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 25px rgba(0,0,0,0.15);
    }
    
    .stat-number {
        font-size: 2.5rem;
        font-weight: bold;
        margin-bottom: 0.5rem;
    }
    
    .stat-label {
        font-size: 0.9rem;
        color: #f6fafeff;
        font-weight: 500;
    }
    
    .stat-icon {
        font-size: 2rem;
        opacity: 0.8;
        margin-bottom: 1rem;
    }
    
    .card-revenue { background: linear-gradient(45deg, #007bff, #0056b3); color: white; }
    .card-clients { background: linear-gradient(45deg, #28a745, #1e7e34); color: white; }
    .card-pets { background: linear-gradient(45deg, #6f42c1, #563d7c); color: white; }
    .card-appointments { background: linear-gradient(45deg, #fd7e14, #e36209); color: white; }
    .card-completed { background: linear-gradient(45deg, #20c997, #138a63); color: white; }
    .card-urgent { background: linear-gradient(45deg, #dc3545, #a71e2a); color: white; }
    .card-products { background: linear-gradient(45deg, #17a2b8, #138496); color: white; }
    .card-sales { background: linear-gradient(45deg, #6610f2, #520dc2); color: white; }
    .card-orders { background: linear-gradient(45deg, #e83e8c, #d91a72); color: white; }
    .card-lowstock { background: linear-gradient(45deg, #ffc107, #e0a800); color: white; }
    
    .chart-container {
        position: relative;
        height: 300px;
        margin: 20px 0;
    }
    
    .chart-container-sm {
        position: relative;
        height: 250px;
        margin: 15px 0;
    }
    
    .table-responsive {
        border-radius: 10px;
        overflow: hidden;
    }
    
    .badge-urgent {
        background: linear-gradient(45deg, #dc3545, #a71e2a);
        color: white;
    }
    
    .badge-lowstock {
        background: linear-gradient(45deg, #ffc107, #e0a800);
        color: white;
    }
    
    .progress {
        height: 8px;
        border-radius: 4px;
    }
    
    .quick-action-btn {
        transition: all 0.3s ease;
        border: none;
        border-radius: 8px;
        padding: 10px 15px;
        margin: 5px;
    }
    
    .quick-action-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }
    
    .section-title {
        border-left: 4px solid #007bff;
        padding-left: 15px;
        margin: 30px 0 20px 0;
        font-weight: 600;
    }
    
    .tab-content {
        padding: 20px 0;
    }
    
    .nav-tabs .nav-link.active {
        font-weight: 600;
        border-bottom: 3px solid #007bff;
    }
</style>
{% endblock %}

{% block content %}
<!-- HEADER -->
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">
        <i class="fas fa-tachometer-alt me-2"></i>Dashboard de Administración
    </h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2">
            <a href="{% url 'admin:index' %}" class="btn btn-sm btn-outline-primary">
                <i class="fas fa-cog me-1"></i>Panel Admin Completo
            </a>
            <form method="post" action="{% url 'administracion:exportar_datos' %}">
                {% csrf_token %}
                <button type="submit" class="btn btn-sm btn-success">
                    <i class="fas fa-file-excel me-1"></i>Exportar Excel
                </button>
            </form>
            <button class="btn btn-sm btn-info" onclick="actualizarDatos()">
                <i class="fas fa-sync-alt me-1"></i>Actualizar
            </button>
        </div>
    </div>
</div>

<!-- NAVEGACIÓN POR PESTAÑAS -->
<ul class="nav nav-tabs" id="dashboardTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button" role="tab">
            <i class="fas fa-chart-bar me-1"></i>Resumen General
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="tienda-tab" data-bs-toggle="tab" data-bs-target="#tienda" type="button" role="tab">
            <i class="fas fa-shopping-cart me-1"></i>Gestión de Tienda
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="citas-tab" data-bs-toggle="tab" data-bs-target="#citas" type="button" role="tab">
            <i class="fas fa-calendar-alt me-1"></i>Gestión de Citas
        </button>
    </li>
</ul>

<div class="tab-content" id="dashboardTabsContent">
    <!-- PESTAÑA 1: RESUMEN GENERAL -->
    <div class="tab-pane fade show active" id="overview" role="tabpanel">
        {% include 'administracion/partials/overview_tab.html' %}
    </div>

    <!-- PESTAÑA 2: GESTIÓN DE TIENDA -->
    <div class="tab-pane fade" id="tienda" role="tabpanel">
        {% include 'administracion/partials/tienda_tab.html' %}
    </div>

    <!-- PESTAÑA 3: GESTIÓN DE CITAS -->
    <div class="tab-pane fade" id="citas" role="tabpanel">
        {% include 'administracion/partials/citas_tab.html' %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
<script>
// Colores para los gráficos
const colors = {
    primary: '#007bff',
    success: '#28a745',
    info: '#17a2b8',
    warning: '#ffc107',
    danger: '#dc3545',
    secondary: '#6c757d',
    dark: '#343a40',
    purple: '#6f42c1',
    pink: '#e83e8c',
    teal: '#20c997',
    orange: '#fd7e14'
};

// Configuración global de Chart.js
Chart.defaults.font.family = "'Segoe UI', 'Helvetica Neue', Arial, sans-serif";
Chart.defaults.font.size = 12;

// Datos iniciales
const citasPorEstado = {{ citas_por_estado_json|safe }};
const mascotasPorTipo = {{ mascotas_por_tipo_json|safe }};
const productosPorCategoria = {{ productos_por_categoria_json|safe }};
const ordenesPorEstado = {{ ordenes_por_estado_json|safe }};
const citasUltimos7Dias = {{ citas_ultimos_7_dias_json|safe }};
const ventasUltimos7Dias = {{ ventas_ultimos_7_dias_json|safe }};

// FUNCIONES EXISTENTES
function actualizarDatos() {
    fetch('{% url "administracion:estadisticas_api" %}')
        .then(response => response.json())
        .then(data => {
            console.log('Datos actualizados:', data);
            mostrarNotificacion('Datos actualizados correctamente', 'success');
        })
        .catch(error => {
            console.error('Error al actualizar:', error);
            mostrarNotificacion('Error al actualizar datos', 'danger');
        });
}

function mostrarNotificacion(mensaje, tipo) {
    const alert = document.createElement('div');
    alert.className = `alert alert-${tipo} alert-dismissible fade show position-fixed`;
    alert.style.cssText = 'top: 80px; right: 20px; z-index: 1050; min-width: 300px;';
    alert.innerHTML = `
        ${mensaje}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(alert);
    
    setTimeout(() => {
        alert.remove();
    }, 3000);
}

// Inicializar cuando el documento esté listo
document.addEventListener('DOMContentLoaded', function() {
    // Actualizar automáticamente cada 5 minutos
    setInterval(actualizarDatos, 300000);
    
    // Inicializar gráficos cuando se cambie de pestaña
    const tabEl = document.querySelector('button[data-bs-target="#overview"]');
    if (tabEl) {
        tabEl.addEventListener('shown.bs.tab', function() {
            // Re-renderizar gráficos si es necesario
            if (typeof renderEstadoCitasChart === 'function') {
                setTimeout(() => {
                    renderEstadoCitasChart();
                    renderTipoMascotasChart();
                    renderProductosCategoriaChart();
                    renderOrdenesEstadoChart();
                    renderTendenciaCitasChart();
                    renderTendenciaVentasChart();
                }, 100);
            }
        });
    }
});
</script>
{% endblock %}