{% extends 'base.html' %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1><i class="fas fa-calendar-alt me-2"></i>Mis Citas Veterinarias</h1>
    <a href="{% url 'citas:solicitar_cita' %}" class="btn btn-primary">
        <i class="fas fa-plus me-1"></i>Solicitar Nueva Cita
    </a>
</div>

{% if not tiene_perfil %}
<div class="alert alert-warning">
    <h4 class="alert-heading"><i class="fas fa-exclamation-triangle me-2"></i>Perfil Incompleto</h4>
    <p>Debes completar tu perfil antes de poder agendar citas.</p>
    <hr>
    <a href="{% url 'clientes:crear_perfil_cliente' %}" class="btn btn-primary">
        <i class="fas fa-user-plus me-1"></i>Completar Mi Perfil
    </a>
</div>
{% elif citas %}
<div class="table-responsive">
    <table class="table table-striped table-hover">
        <thead class="table-dark">
            <tr>
                <th>Fecha y Hora</th>
                <th>Mascota</th>
                <th>Tipo</th>
                <th>Prioridad</th>
                <th>Estado</th>
                <th>Motivo</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody>
            {% for cita in citas %}
            <tr>
                <td>
                    <strong>{{ cita.fecha|date:"d/m/Y" }}</strong><br>
                    <small class="text-muted">{{ cita.fecha|date:"H:i" }}</small>
                </td>
                <td>
                    <strong>{{ cita.mascota.nombre }}</strong><br>
                    <small class="text-muted">{{ cita.mascota.get_especie_display }}</small>
                </td>
                <td>{{ cita.get_tipo_display }}</td>
                <td>
                    <span class="badge bg-{% if cita.prioridad == 'emergencia' %}danger{% elif cita.prioridad == 'urgente' %}warning{% else %}secondary{% endif %}">
                        {{ cita.get_prioridad_display }}
                    </span>
                </td>
                <td>
                    <span class="badge bg-{% if cita.estado == 'completada' %}success{% elif cita.estado == 'cancelada' %}danger{% elif cita.estado == 'confirmada' %}info{% elif cita.estado == 'en_progreso' %}primary{% else %}warning{% endif %}">
                        {{ cita.get_estado_display }}
                    </span>
                    {% if cita.confirmada_por_cliente %}
                    <br><small class="text-success"><i class="fas fa-check-circle"></i> Confirmada por ti</small>
                    {% endif %}
                </td>
                <td>{{ cita.motivo|truncatewords:8 }}</td>
                <td>
                    <div class="btn-group btn-group-sm">
                        {# ELIMINAMOS EL BOTÓN CONFIRMAR - Ya no es necesario porque se confirma en el modal #}
                        
                        {% if cita.estado == 'confirmada' or cita.estado == 'programada' %}
                        <a href="{% url 'citas:cancelar_cita' cita.id %}" class="btn btn-danger" 
                           onclick="return confirm('¿Estás seguro de que quieres cancelar esta cita?')">
                            <i class="fas fa-times me-1"></i>Cancelar
                        </a>
                        {% else %}
                        <span class="text-muted">No disponible</span>
                        {% endif %}
                    </div>
                </td>
            </tr>
            {% if cita.sintomas %}
            <tr class="bg-light">
                <td colspan="7">
                    <small><strong>Síntomas:</strong> {{ cita.sintomas|truncatewords:20 }}</small>
                </td>
            </tr>
            {% endif %}
            {% endfor %}
        </tbody>
    </table>
</div>

{% else %}
<div class="alert alert-info">
    <h4 class="alert-heading"><i class="fas fa-info-circle me-2"></i>No tienes citas programadas</h4>
    <p>No se encontraron citas en tu historial. ¿Te gustaría agendar una consulta para tu mascota?</p>
    <hr>
    <a href="{% url 'citas:solicitar_cita' %}" class="btn btn-primary">
        <i class="fas fa-calendar-plus me-1"></i>Solicitar Mi Primera Cita
    </a>
</div>
{% endif %}

{% if messages %}
    {% for message in messages %}
    <div class="alert alert-{{ message.tags }} alert-dismissible fade show mt-3">
        <i class="fas fa-{% if message.tags == 'success' %}check-circle{% else %}exclamation-triangle{% endif %} me-2"></i>
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    {% endfor %}
{% endif %}
{% endblock %}