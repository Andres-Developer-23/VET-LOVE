{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1><i class="fas fa-calendar-alt me-2"></i>{% if es_admin %}Todas las Citas{% else %}Mis Citas Veterinarias{% endif %}</h1>
    {% if not es_admin or user.cliente %}
    <a href="{% url 'citas:solicitar_cita' %}" class="btn btn-primary">
        <i class="fas fa-plus me-1"></i>Solicitar Nueva Cita
    </a>
    {% endif %}
</div>

{% if es_admin %}
<div class="alert alert-info mb-4">
    <i class="fas fa-shield-alt me-2"></i><strong>Modo Administrador:</strong> Estás viendo todas las citas del sistema.
    {% if not user.cliente %}
    Para solicitar citas, primero <a href="{% url 'clientes:crear_perfil_cliente' %}" class="alert-link">crea un perfil de cliente</a>.
    {% endif %}
</div>
{% endif %}

{% if not tiene_perfil %}
<div class="alert alert-warning">
    <h4 class="alert-heading"><i class="fas fa-exclamation-triangle me-2"></i>Perfil Incompleto</h4>
    <p>Debes completar tu perfil antes de poder agendar citas.</p>
    <hr>
    <a href="{% url 'clientes:crear_perfil_cliente' %}" class="btn btn-primary">
        <i class="fas fa-user-plus me-1"></i>Completar Mi Perfil
    </a>
</div>
{% elif citas %}
<div class="table-responsive">
    <table class="table table-striped table-hover">
        <thead class="table-dark">
            <tr>
                <th>Fecha y Hora</th>
                <th>Mascota</th>
                {% if es_admin %}<th>Cliente</th>{% endif %}
                <th>Tipo</th>
                <th>Prioridad</th>
                <th>Estado</th>
                <th>Motivo</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody>
            {% for cita in citas %}
            <tr>
                <td>
                    <strong>{{ cita.fecha|date:"d/m/Y" }}</strong><br>
                    <small class="text-muted">{{ cita.fecha|date:"H:i" }}</small>
                </td>
                <td>
                    <strong>{{ cita.mascota.nombre }}</strong><br>
                    <small class="text-muted">{{ cita.mascota.get_tipo_display }}</small>
                </td>
                {% if es_admin %}
                <td>
                    <strong>{{ cita.mascota.cliente.usuario.get_full_name|default:cita.mascota.cliente.usuario.username }}</strong><br>
                    <small class="text-muted">{{ cita.mascota.cliente.telefono|default:"Sin teléfono" }}</small>
                </td>
                {% endif %}
                <td>{{ cita.get_tipo_display }}</td>
                <td>
                    <span class="badge bg-{% if cita.prioridad == 'emergencia' %}danger{% elif cita.prioridad == 'urgente' %}warning{% else %}secondary{% endif %}">
                        {{ cita.get_prioridad_display }}
                    </span>
                </td>
                <td>
                    <span class="badge bg-{% if cita.estado == 'completada' %}success{% elif cita.estado == 'cancelada' %}danger{% elif cita.estado == 'confirmada' %}info{% elif cita.estado == 'en_progreso' %}primary{% else %}warning{% endif %}">
                        {{ cita.get_estado_display }}
                    </span>
                    {% if cita.confirmada_por_cliente %}
                    <br><small class="text-success"><i class="fas fa-check-circle"></i> Confirmada por ti</small>
                    {% endif %}
                </td>
                <td>{{ cita.motivo|truncatewords:8 }}</td>
                <td>
                    <div class="btn-group btn-group-sm">
                        {# ELIMINAMOS EL BOTÓN CONFIRMAR - Ya no es necesario porque se confirma en el modal #}
                        
                        {% if cita.estado == 'confirmada' or cita.estado == 'programada' %}
                        <button type="button" class="btn btn-danger btn-cancelar-cita"
                                data-cita-id="{{ cita.id }}"
                                data-cita-fecha="{{ cita.fecha|date:'d/m/Y H:i' }}"
                                data-mascota="{{ cita.mascota.nombre }}">
                            <i class="fas fa-times me-1"></i>Cancelar
                        </button>
                        {% else %}
                        <span class="text-muted">No disponible</span>
                        {% endif %}
                    </div>
                </td>
            </tr>
            {% if cita.sintomas %}
            <tr class="bg-light">
                <td colspan="{% if es_admin %}8{% else %}7{% endif %}">
                    <small><strong>Síntomas:</strong> {{ cita.sintomas|truncatewords:20 }}</small>
                </td>
            </tr>
            {% endif %}
            {% endfor %}
        </tbody>
    </table>
</div>

{% else %}
<div class="alert alert-info">
    <h4 class="alert-heading"><i class="fas fa-info-circle me-2"></i>No tienes citas programadas</h4>
    <p>No se encontraron citas en tu historial. ¿Te gustaría agendar una consulta para tu mascota?</p>
    <hr>
    <a href="{% url 'citas:solicitar_cita' %}" class="btn btn-primary">
        <i class="fas fa-calendar-plus me-1"></i>Solicitar Mi Primera Cita
    </a>
</div>
{% endif %}

{% if messages %}
    {% for message in messages %}
    <div class="alert alert-{{ message.tags }} alert-dismissible fade show mt-3">
        <i class="fas fa-{% if message.tags == 'success' %}check-circle{% else %}exclamation-triangle{% endif %} me-2"></i>
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    {% endfor %}
{% endif %}

<!-- Modal de Confirmación de Cancelación -->
<div class="modal fade" id="modalCancelarCita" tabindex="-1" aria-labelledby="modalCancelarCitaLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="modalCancelarCitaLabel">
                    <i class="fas fa-exclamation-triangle me-2"></i>Confirmar Cancelación
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <h6><i class="fas fa-exclamation-triangle me-2"></i>¿Estás seguro de que quieres cancelar esta cita?</h6>
                </div>

                <div class="card">
                    <div class="card-body">
                        <h6>Detalles de la cita a cancelar:</h6>
                        <div id="citaDetalleCancelacion">
                            <!-- Los detalles se llenarán con JavaScript -->
                        </div>
                    </div>
                </div>

                <div class="alert alert-info mt-3">
                    <small>
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Política de cancelación:</strong> Las citas deben cancelarse con al menos 4 horas de anticipación.
                        Si cancelas con menos tiempo, podrías perder el derecho a reagendar.
                    </small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>Mantener Cita
                </button>
                <button type="button" class="btn btn-danger" id="btnConfirmarCancelacion">
                    <i class="fas fa-check me-1"></i>Sí, Cancelar Cita
                </button>
            </div>
        </div>
    </div>
</div>

{% block extra_js %}
<script>
// Funcionalidad para cancelar citas
document.addEventListener('DOMContentLoaded', function() {
    const modalCancelar = new bootstrap.Modal(document.getElementById('modalCancelarCita'));
    const btnConfirmarCancelacion = document.getElementById('btnConfirmarCancelacion');
    const citaDetalleCancelacion = document.getElementById('citaDetalleCancelacion');
    let citaIdActual = null;

    // Función para mostrar alerta
    function mostrarAlerta(mensaje, tipo = 'info') {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${tipo} alert-dismissible fade show`;
        alertDiv.innerHTML = `
            ${mensaje}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.querySelector('.container').insertBefore(alertDiv, document.querySelector('.container').firstChild);
        setTimeout(() => alertDiv.remove(), 5000);
    }

    // Event listeners para botones de cancelar
    document.querySelectorAll('.btn-cancelar-cita').forEach(btn => {
        btn.addEventListener('click', function() {
            const citaId = this.getAttribute('data-cita-id');
            const citaFecha = this.getAttribute('data-cita-fecha');
            const mascotaNombre = this.getAttribute('data-mascota');

            citaIdActual = citaId;

            // Llenar detalles en el modal
            citaDetalleCancelacion.innerHTML = `
                <strong>Fecha y Hora:</strong> ${citaFecha}<br>
                <strong>Mascota:</strong> ${mascotaNombre}<br>
                <strong>ID de Cita:</strong> #${citaId}
            `;

            modalCancelar.show();
        });
    });

    // Confirmar cancelación
    btnConfirmarCancelacion.addEventListener('click', function() {
        if (!citaIdActual) return;

        // Mostrar loading
        btnConfirmarCancelacion.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Cancelando...';
        btnConfirmarCancelacion.disabled = true;

        // Cerrar modal
        modalCancelar.hide();

        // Crear formulario y enviar
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `{% url 'citas:cancelar_cita' 0 %}`.replace('0', citaIdActual);  // URL de Django

        // Agregar CSRF token
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
        if (csrfToken) {
            const csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = 'csrfmiddlewaretoken';
            csrfInput.value = csrfToken.value;
            form.appendChild(csrfInput);
        }

        document.body.appendChild(form);
        form.submit();
    });

    // Resetear modal cuando se cierra
    document.getElementById('modalCancelarCita').addEventListener('hidden.bs.modal', function() {
        btnConfirmarCancelacion.innerHTML = '<i class="fas fa-check me-1"></i>Sí, Cancelar Cita';
        btnConfirmarCancelacion.disabled = false;
        citaIdActual = null;
    });

    console.log('Funcionalidad de cancelar citas inicializada correctamente');
});
</script>
{% endblock %}
{% endblock %}