{% extends 'base.html' %}
{% load crispy_forms_tags %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'citas/css/solicitar_cita.css' %}">
{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-10">
        <h2><i class="fas fa-calendar-plus me-2"></i>Solicitar Nueva Cita Veterinaria</h2>
        
        {% if messages %}
            {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
            {% endfor %}
        {% endif %}
        
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="card-title mb-0"><i class="fas fa-file-medical me-2"></i>Formulario de Cita Médica</h5>
            </div>
            <div class="card-body">
                <form method="post" id="citaForm">
                    {% csrf_token %}
                    
                    {% if form.non_field_errors %}
                    <div class="alert alert-danger">
                        {% for error in form.non_field_errors %}
                            {{ error }}
                        {% endfor %}
                    </div>
                    {% endif %}
                    
                    <!-- Información de la Mascota -->
                    <div class="card mb-4">
                        <div class="card-header bg-light">
                            <h6 class="mb-0"><i class="fas fa-paw me-2"></i>Información del Paciente</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="id_mascota" class="form-label">Mascota Paciente</label>
                                        {{ form.mascota }}
                                        {% if form.mascota.errors %}
                                        <div class="text-danger">
                                            {% for error in form.mascota.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Información de la Mascota</label>
                                        <div id="info_mascota" class="p-3 border rounded bg-light">
                                            <small class="text-muted">Selecciona una mascota para ver su información completa</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Detalles de la Cita -->
                    <div class="card mb-4">
                        <div class="card-header bg-light">
                            <h6 class="mb-0"><i class="fas fa-calendar-alt me-2"></i>Detalles de la Cita</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="id_fecha" class="form-label">Fecha y Hora Preferidas</label>
                                        {{ form.fecha }}
                                        {% if form.fecha.errors %}
                                        <div class="text-danger">
                                            {% for error in form.fecha.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="id_tipo" class="form-label">Tipo de Consulta</label>
                                        {{ form.tipo }}
                                        {% if form.tipo.errors %}
                                        <div class="text-danger">
                                            {% for error in form.tipo.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="id_prioridad" class="form-label">Nivel de Urgencia</label>
                                        {{ form.prioridad }}
                                        {% if form.prioridad.errors %}
                                        <div class="text-danger">
                                            {% for error in form.prioridad.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="alert alert-warning border">
                                        <small>
                                            <strong><i class="fas fa-exclamation-triangle me-1"></i>Nota:</strong><br>
                                            Las citas marcadas como <strong>Urgentes</strong> o <strong>Emergencias</strong> requieren descripción de síntomas.
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Información de Contacto -->
                    <div class="card mb-4">
                        <div class="card-header bg-light">
                            <h6 class="mb-0"><i class="fas fa-phone me-2"></i>Información de Contacto</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="id_telefono_contacto" class="form-label">Teléfono de Contacto</label>
                                        {{ form.telefono_contacto }}
                                        {% if form.telefono_contacto.errors %}
                                        <div class="text-danger">
                                            {% for error in form.telefono_contacto.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="id_email_contacto" class="form-label">Email de Contacto</label>
                                        {{ form.email_contacto }}
                                        {% if form.email_contacto.errors %}
                                        <div class="text-danger">
                                            {% for error in form.email_contacto.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Información Médica -->
                    <div class="card mb-4">
                        <div class="card-header bg-light">
                            <h6 class="mb-0"><i class="fas fa-stethoscope me-2"></i>Información Médica</h6>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label for="id_motivo" class="form-label">Motivo Principal de la Consulta</label>
                                {{ form.motivo }}
                                {% if form.motivo.errors %}
                                <div class="text-danger">
                                    {% for error in form.motivo.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>
                            
                            <div class="mb-3">
                                <label for="id_sintomas" class="form-label">Síntomas Presentados</label>
                                {{ form.sintomas }}
                                <div class="form-text">Describa todos los síntomas que ha observado en su mascota.</div>
                                {% if form.sintomas.errors %}
                                <div class="text-danger">
                                    {% for error in form.sintomas.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="id_antecedentes" class="form-label">Antecedentes Médicos Relevantes</label>
                                        {{ form.antecedentes }}
                                        <div class="form-text">Enfermedades previas, cirugías, condiciones crónicas.</div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="id_medicamentos_actuales" class="form-label">Medicamentos Actuales</label>
                                        {{ form.medicamentos_actuales }}
                                        <div class="form-text">Medicamentos, suplementos o tratamientos actuales.</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="id_alergias" class="form-label">Alergias Conocidas</label>
                                {{ form.alergias }}
                                <div class="form-text">Alergias a medicamentos, alimentos, etc.</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="alert alert-info">
                        <h6><i class="fas fa-info-circle me-2"></i>Información importante:</h6>
                        <ul class="mb-0">
                            <li>Todos los campos marcados como requeridos son obligatorios</li>
                            <li>Para emergencias fuera de horario, llame al: <strong>555-EMERGENCIA (555-36373642)</strong></li>
                            <li>Llegue 15 minutos antes de su cita para completar el registro</li>
                            <li>Traiga el carnet de vacunación de su mascota si está disponible</li>
                            <li>Si su mascota no tiene información de edad completa, por favor actualícela en la sección de mascotas</li>
                        </ul>
                    </div>
                    
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <a href="{% url 'citas:mis_citas' %}" class="btn btn-secondary me-md-2">
                            <i class="fas fa-times me-1"></i>Cancelar
                        </a>
                        <button type="button" class="btn btn-primary" id="btnSolicitarCita">
                            <i class="fas fa-calendar-check me-1"></i>Solicitar Cita Médica
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <div class="card mt-4">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="fas fa-clock me-2"></i>Horarios y Políticas</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Horario de Atención:</h6>
                        <ul>
                            <li><strong>Lunes a Viernes:</strong> 8:00 am - 8:00 pm</li>
                            <li><strong>Sábados:</strong> 8:00 am - 2:00 pm</li>
                            <li><strong>Domingos:</strong> Cerrado (Solo Emergencias)</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6>Políticas de la Clínica:</h6>
                        <ul>
                            <li><strong>Puntualidad:</strong> Llegue 15 minutos antes</li>
                            <li><strong>Cancelaciones:</strong> Mínimo 4 horas de anticipación</li>
                            <li><strong>No show:</strong> 3 inasistencias pueden suspender el servicio</li>
                            <li><strong>Pagos:</strong> Se aceptan todas las tarjetas y efectivo</li>
                            <li><strong>Documentación:</strong> Traer carnet de vacunación</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Confirmación -->
<div class="modal fade" id="confirmacionModal" tabindex="-1" aria-labelledby="confirmacionModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="confirmacionModalLabel">
                    <i class="fas fa-calendar-check me-2"></i>Confirmar Cita Veterinaria
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <h6><i class="fas fa-info-circle me-2"></i>Revise los detalles de su cita antes de confirmar:</h6>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <h6>Información del Paciente:</h6>
                        <div id="modalMascotaInfo" class="mb-3 p-2 border rounded bg-light">
                            <!-- Información de la mascota se llenará con JavaScript -->
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6>Detalles de la Cita:</h6>
                        <div id="modalCitaInfo" class="mb-3 p-2 border rounded bg-light">
                            <!-- Información de la cita se llenará con JavaScript -->
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-12">
                        <h6>Información de Contacto:</h6>
                        <div id="modalContactoInfo" class="mb-3 p-2 border rounded bg-light">
                            <!-- Información de contacto se llenará con JavaScript -->
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-12">
                        <h6>Motivo y Síntomas:</h6>
                        <div id="modalMotivoInfo" class="mb-3 p-2 border rounded bg-light">
                            <!-- Información del motivo se llenará con JavaScript -->
                        </div>
                    </div>
                </div>
                
                <div class="alert alert-warning">
                    <small>
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Importante:</strong> Al confirmar, acepta nuestras políticas de cancelación y asistencia. 
                        Las cancelaciones deben realizarse con al menos 4 horas de anticipación.
                    </small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>Cancelar Cita
                </button>
                <button type="button" class="btn btn-success" id="btnConfirmarCita">
                    <i class="fas fa-check me-1"></i>Confirmar y Solicitar Cita
                </button>
            </div>
        </div>
    </div>
</div>

{% block extra_js %}
<script>
// Datos dinámicos para el JavaScript
window.mascotasData = {
    {% for mascota in mascotas %}
    '{{ mascota.id }}': {
        'nombre': '{{ mascota.nombre }}',
        'especie': '{{ mascota.get_tipo_display }}',
        'raza': '{{ mascota.raza|default:"No especificada" }}',
        'edad': '{{ mascota.edad|default_if_none:"No especificada" }}',
        'fecha_nacimiento': '{{ mascota.fecha_nacimiento|date:"d/m/Y"|default:"No especificada" }}',
        'peso': '{{ mascota.peso_actual|default:"No especificado" }}',
        'sexo': '{{ mascota.get_sexo_display|default:"No especificado" }}',
        'color': '{{ mascota.color|default:"No especificado" }}'
    }{% if not forloop.last %},{% endif %}
    {% endfor %}
};
</script>
<script src="{% static 'citas/js/solicitar_cita.js' %}"></script>
{% endblock %}
{% endblock %}  