{% extends 'administracion/dashboard.html' %}
{% load static %}

{% block titulo_pagina %}Crear Notificación Personalizada{% endblock %}

{% block contenido_principal %}
<div class="row">
    <div class="col-12">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{% url 'administracion:dashboard_admin' %}">Dashboard</a></li>
                <li class="breadcrumb-item"><a href="{% url 'administracion:gestion_notificaciones' %}">Notificaciones</a></li>
                <li class="breadcrumb-item active" aria-current="page">Crear Notificación</li>
            </ol>
        </nav>

        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2><i class="fas fa-plus-circle me-2"></i>{{ titulo }}</h2>
                <p class="text-muted mb-0">Envía notificaciones personalizadas a clientes específicos o a todos los usuarios</p>
            </div>
            <a href="{% url 'administracion:gestion_notificaciones' %}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-1"></i>Volver a Gestión
            </a>
        </div>

        <div class="row">
            <div class="col-lg-8">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-edit me-2"></i>Detalles de la Notificación</h5>
                    </div>
                    <div class="card-body">
                        <form method="post">
                            {% csrf_token %}

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="{{ form.destinatario.id_for_label }}" class="form-label">
                                        <i class="fas fa-users me-1"></i>Destinatario
                                    </label>
                                    {{ form.destinatario }}
                                    {% if form.destinatario.errors %}
                                        <div class="text-danger small">{{ form.destinatario.errors.0 }}</div>
                                    {% endif %}
                                    <div class="form-text">
                                        <small class="text-muted">
                                            Selecciona si enviar a un cliente específico o a todos los usuarios
                                        </small>
                                    </div>
                                </div>

                                <div class="col-md-6 mb-3" id="cliente-field" style="display: none;">
                                    <label for="{{ form.cliente.id_for_label }}" class="form-label">
                                        <i class="fas fa-user me-1"></i>Cliente Específico
                                    </label>
                                    {{ form.cliente }}
                                    {% if form.cliente.errors %}
                                        <div class="text-danger small">{{ form.cliente.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="{{ form.tipo.id_for_label }}" class="form-label">
                                        <i class="fas fa-tag me-1"></i>Tipo de Notificación
                                    </label>
                                    {{ form.tipo }}
                                    {% if form.tipo.errors %}
                                        <div class="text-danger small">{{ form.tipo.errors.0 }}</div>
                                    {% endif %}
                                </div>

                                <div class="col-md-6 mb-3">
                                    <label for="{{ form.prioridad.id_for_label }}" class="form-label">
                                        <i class="fas fa-exclamation-triangle me-1"></i>Prioridad
                                    </label>
                                    {{ form.prioridad }}
                                    {% if form.prioridad.errors %}
                                        <div class="text-danger small">{{ form.prioridad.errors.0 }}</div>
                                    {% endif %}
                                    <div class="form-text">
                                        <small class="text-muted">
                                            La prioridad afecta cómo se muestra la notificación al usuario
                                        </small>
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="{{ form.url_relacionada.id_for_label }}" class="form-label">
                                        <i class="fas fa-link me-1"></i>Enlace Relacionado
                                    </label>
                                    {{ form.url_relacionada }}
                                    {% if form.url_relacionada.errors %}
                                        <div class="text-danger small">{{ form.url_relacionada.errors.0 }}</div>
                                    {% endif %}
                                    <div class="form-text">
                                        <small class="text-muted">
                                            Opcional: URL a la que el usuario será redirigido al hacer clic
                                        </small>
                                    </div>
                                </div>

                                <div class="col-md-6 mb-3">
                                    <div class="alert alert-info small">
                                        <i class="fas fa-info-circle me-1"></i>
                                        <strong>Nota:</strong> Las notificaciones se envían inmediatamente y aparecen en el panel del cliente.
                                    </div>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="{{ form.titulo.id_for_label }}" class="form-label">
                                    <i class="fas fa-heading me-1"></i>Título
                                </label>
                                {{ form.titulo }}
                                {% if form.titulo.errors %}
                                    <div class="text-danger small">{{ form.titulo.errors.0 }}</div>
                                {% endif %}
                                <div class="form-text">
                                    <small class="text-muted">
                                        Título descriptivo de la notificación (máx. 200 caracteres)
                                    </small>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="{{ form.mensaje.id_for_label }}" class="form-label">
                                    <i class="fas fa-envelope me-1"></i>Mensaje
                                </label>
                                {{ form.mensaje }}
                                {% if form.mensaje.errors %}
                                    <div class="text-danger small">{{ form.mensaje.errors.0 }}</div>
                                {% endif %}
                                <div class="form-text">
                                    <small class="text-muted">
                                        Contenido detallado de la notificación
                                    </small>
                                </div>
                            </div>

                            <div class="d-flex gap-2">
                                <button type="submit" class="btn btn-primary" id="submit-btn">
                                    <i class="fas fa-paper-plane me-1"></i>Enviar Notificación
                                </button>
                                <a href="{% url 'administracion:gestion_notificaciones' %}" class="btn btn-outline-secondary">
                                    <i class="fas fa-times me-1"></i>Cancelar
                                </a>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <!-- Información de ayuda -->
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="fas fa-info-circle me-2"></i>Ayuda</h6>
                    </div>
                    <div class="card-body">
                        <h6>Tipos de Notificación:</h6>
                        <ul class="list-unstyled small mb-3">
                            <li><strong>General:</strong> Información general</li>
                            <li><strong>Cita:</strong> Recordatorios de citas</li>
                            <li><strong>Vacuna:</strong> Información sobre vacunas</li>
                            <li><strong>Medicamento:</strong> Recordatorios de medicamentos</li>
                            <li><strong>Sistema:</strong> Actualizaciones del sistema</li>
                        </ul>

                        <h6>Prioridades:</h6>
                        <ul class="list-unstyled small mb-3">
                            <li><span class="badge bg-danger">Urgente</span> - Emergencias médicas</li>
                            <li><span class="badge bg-warning">Alta</span> - Vacunas, citas importantes</li>
                            <li><span class="badge bg-primary">Normal</span> - Información general</li>
                            <li><span class="badge bg-secondary">Baja</span> - Información no crítica</li>
                        </ul>

                        <div class="alert alert-info small">
                            <i class="fas fa-lightbulb me-1"></i>
                            <strong>Consejo:</strong> Las notificaciones se envían inmediatamente y aparecen en el panel del cliente.
                        </div>
                    </div>
                </div>

                <!-- Vista previa -->
                <div class="card mt-3">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="fas fa-eye me-2"></i>Vista Previa</h6>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-light border">
                            <h6 id="preview-titulo">Título de la notificación</h6>
                            <p id="preview-mensaje" class="mb-0">Mensaje de la notificación aparecerá aquí...</p>
                        </div>
                        <small class="text-muted">
                            Esta es una vista previa de cómo se verá la notificación para el cliente.
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Función para mostrar/ocultar campo cliente según destinatario
function toggleClienteField() {
    const destinatario = document.getElementById('{{ form.destinatario.id_for_label }}').value;
    const clienteField = document.getElementById('cliente-field');
    const clienteSelect = document.getElementById('{{ form.cliente.id_for_label }}');
    const submitBtn = document.getElementById('submit-btn');

    if (destinatario === 'cliente') {
        clienteField.style.display = 'block';
        clienteSelect.required = true;
        submitBtn.innerHTML = '<i class="fas fa-paper-plane me-1"></i>Enviar a Cliente';
    } else if (destinatario === 'todos') {
        clienteField.style.display = 'none';
        clienteSelect.required = false;
        clienteSelect.value = '';
        submitBtn.innerHTML = '<i class="fas fa-paper-plane me-1"></i>Enviar a Todos';
    }
}

// Actualizar vista previa en tiempo real
function actualizarVistaPrevia() {
    const titulo = document.getElementById('{{ form.titulo.id_for_label }}').value || 'Título de la notificación';
    const mensaje = document.getElementById('{{ form.mensaje.id_for_label }}').value || 'Mensaje de la notificación aparecerá aquí...';

    document.getElementById('preview-titulo').textContent = titulo;
    document.getElementById('preview-mensaje').textContent = mensaje;
}

// Event listeners
document.addEventListener('DOMContentLoaded', function() {
    // Inicializar campo cliente
    toggleClienteField();

    // Listener para cambio de destinatario
    document.getElementById('{{ form.destinatario.id_for_label }}').addEventListener('change', toggleClienteField);

    // Actualizar vista previa cuando cambien los campos
    document.getElementById('{{ form.titulo.id_for_label }}').addEventListener('input', actualizarVistaPrevia);
    document.getElementById('{{ form.mensaje.id_for_label }}').addEventListener('input', actualizarVistaPrevia);

    // Inicializar vista previa
    actualizarVistaPrevia();
});
</script>
{% endblock %}