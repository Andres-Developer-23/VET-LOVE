{% extends 'base.html' %}
{% load static %}

{% block title %}Procesando Pago - Veterinaria Vet Love{% endblock %}

{% block extra_css %}
<style>
.checkout-container {
    min-height: 60vh;
    display: flex;
    align-items: center;
    justify-content: center;
}

.checkout-card {
    max-width: 500px;
    width: 100%;
}

.checkout-spinner {
    width: 3rem;
    height: 3rem;
}
</style>
{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="checkout-container">
        <div class="card checkout-card shadow">
            <div class="card-body text-center p-5">
                <div id="loading-state">
                    <div class="spinner-border text-primary checkout-spinner mb-4" role="status">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                    <h4>Preparando pago seguro</h4>
                    <p class="text-muted">Conectando con Epayco...</p>
                </div>

                <div id="checkout-container" style="display: none;">
                    <!-- El checkout de Epayco se renderizará aquí -->
                </div>

                <div id="error-state" style="display: none;">
                    <div class="text-danger mb-3">
                        <i class="fas fa-exclamation-triangle fa-3x"></i>
                    </div>
                    <h5>Error en el pago</h5>
                    <p class="text-muted" id="error-message">Ha ocurrido un error al procesar el pago.</p>
                    <a href="{% url 'tienda:checkout' %}" class="btn btn-primary">
                        <i class="fas fa-arrow-left me-2"></i>Volver al checkout
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Información de debug -->
{% if debug %}
<div class="container mt-3">
    <div class="alert alert-info">
        <strong>Debug Info:</strong><br>
        Orden: {{ orden.numero_orden }}<br>
        <strong>Datos enviados a Epayco:</strong><br>
        <pre>{{ epayco_data|dictsort:0 }}</pre>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<!-- SDK de Epayco -->
<script type="text/javascript" src="https://checkout.epayco.co/checkout.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Datos de configuración de Epayco
    const epaycoData = {{ epayco_data|safe }};

    console.log('Iniciando checkout con Epayco SDK');
    console.log('Datos de Epayco:', epaycoData);

    try {
        // Configurar el handler de Epayco con los datos directos
        const handler = ePayco.checkout.configure({
            key: epaycoData.key,
            test: epaycoData.test === 'true'
        });

        // Ocultar loading y mostrar checkout
        document.getElementById('loading-state').style.display = 'none';
        document.getElementById('checkout-container').style.display = 'block';

        // Abrir el checkout con todos los parámetros
        handler.open(epaycoData);

        console.log('Checkout de Epayco iniciado correctamente');

    } catch (error) {
        console.error('Error al inicializar Epayco checkout:', error);
        showError('Error al conectar con Epayco. Por favor, verifica tu conexión a internet e intenta nuevamente.');
    }
});

function showError(message) {
    document.getElementById('loading-state').style.display = 'none';
    document.getElementById('checkout-container').style.display = 'none';
    document.getElementById('error-state').style.display = 'block';
    document.getElementById('error-message').textContent = message;
}
</script>
{% endblock %}